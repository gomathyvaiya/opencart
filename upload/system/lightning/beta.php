<?php require_once(DIR_SYSTEM."lightning/config.php");global$light_sqltime,$Wdj,$Wfw,$Wfx,$Wy,$Wdb,$Wfy;$Wdj=@disk_free_space(DIR_CACHE);if($Wdj<10)$Wdj=2*500*1024*1024;$Wfw=array("store","setting","language","currency","weight_class","length_class","category","layout_route","extension","category_to_layout","banner_image","information",/*2.0*/"event","layout_module");$Wfy=true;$Wfx=-1;function Wcu(&$driver){$Wfz=new light_db($driver);$driver=$Wfz;}class light_db{public$driver;public function __construct($driver){global$Wy,$Wdb,$light_sqltime;$Wy=DIR_CACHE."lightning/beta";$Wdb=$light_sqltime*60;Waz();$this->driver=$driver;}private function Wa_($Wf_,$Wga=false){$Wf_=str_replace('`','',$Wf_);if(!$Wf_)return 0;static$Wgb;global$Wy;if(!$Wga and!empty($Wgb[$Wf_]))return$Wgb[$Wf_];$Wgc=$Wy."/qwert";$W_=$Wgc."/$Wf_";if($Wga){Wba($Wgc);if(!file_exists($W_))file_put_contents($W_,'');touch($W_);$Wgb[$Wf_]=time();return$Wgb[$Wf_];}if(!file_exists($W_))$Wgb[$Wf_]=0;else$Wgb[$Wf_]=filemtime($W_);return$Wgb[$Wf_];}private function Wbb($Wep,$Wba){$Wgb=array_merge(Wbc("FROM "," ",$Wep),Wbc("JOIN "," ",$Wep));foreach($Wgb as$Wf_)if($this->Wa_($Wf_)>=$Wba)return false;return true;}private function Wbd($Wep){$Wgb=array_merge(Wbc("FROM "," ",$Wep),Wbc("INTO "," ",$Wep),Wbc("UPDATE "," ",$Wep));foreach($Wgb as$Wf_)$this->Wa_($Wf_,true);}public function query($Wep){static$Wgd;global$Wej,$Wek,$Wge,$Wcb,$Wgf;if(!$Wgd){$Wgd=microtime(true);$Wgg=true;}else$Wgg=false;static$Wgh;if($Wgh++>10000){$Wgh=0;global$Wed;if($Wed){$Wgi=microtime(true)-$Wed;$Wgi/=60;if($Wgi>60*10){$Wgj=debug_backtrace();$Wax="";foreach($Wgj as$Wbk=>$Wey){$Wgk=$Wey["function"];if($Wgk=="call_user_func_array")break;if(!empty($Wey["class"]))$Wgk=$Wey["class"].":".$Wgk;if(!empty($Wey["line"]))$Wgk.=" [".$Wey["line"]."]";if($Wax)$Wax=$Wgk." -> ".$Wax;else$Wax=$Wgk;}global$Wv;file_put_contents(DIR_CACHE."lightning/bad","\n\n\nPID: ".getmypid()." URI:".$_SERVER["REQUEST_URI"]." $Wv \n\n SQL: $Wep \n\n Trace: $Wax",FILE_APPEND);}if($Wgi>60*11)die("Hanged, killed by Lightning");}}global$Wx,$light_optimize_backend,$Wp,$light_cache_sql,$Wee,$Wef,$light_cache_only_slow_sql,$Wgl;if($Wx&&time()-$Wx>30){global$Wgm,$Wv;if($Wgm)$Wgm->Wcr("Page generation was killed (took more then 30 sec) - ".$Wv);exit;}$Wgn=0.05;$Wgo=false;$Wgp=strtoupper(substr($Wep,0,6));global$light_optimize;if($light_optimize&&$Wgp=="SELECT")if((!$Wgl or$Wp)and($light_optimize_backend or defined("LIGHT_FRONTEND"))){Wcm($Wep);$Wgo=true;Wbe($Wep);if(is_array($Wep)){$Wev=Wbf($Wep);if($Wge)Wc_($Wev);if($Wgg){$Wej+=microtime(true)-$Wgd;$Wgd=false;}return$Wev;}}if(!$light_cache_sql or$Wgl){$Wee++;$Wba=microtime(true);$Wev=$this->driver->query($Wep);$Wgq=microtime(true)-$Wba;$Wek+=$Wgq;if($Wcb)$Wgf[]=array('bp'=>$Wep,'bq'=>false,'br'=>$Wgq,'bs'=>Wdf());if($Wge)Wc_($Wev);if($Wgg){$Wej+=microtime(true)-$Wgd;$Wgd=false;}return$Wev;}$Wef++;if($Wgp=="SELECT"){if(!$Wgo)Wcm($Wep);global$Wfx;if($Wfx>=0&&strpos($Wep,"FOUND_ROWS()")){$Wgr=Wy(" as ","",$Wep);if(!$Wgr)$Wgr=Wy(" AS ","",$Wep);$Wgr=str_replace("`","",$Wgr);$Wgr=str_replace("'","",$Wgr);if(!$Wgr)$Wgr="FOUND_ROWS()";$Wev=Wbf(array(array($Wgr=>$Wfx)));if($Wge)Wc_($Wev);if($Wgg){$Wej+=microtime(true)-$Wgd;$Wgd=false;}return$Wev;}$Wev=Wah($Wep);global$light_sql_frontend_delay,$Wgs;if($Wgs and ((defined("LIGHT_FRONTEND")and($Wgs>time()-$light_sql_frontend_delay))or$this->Wbb($Wep,$Wgs))){if($Wev!==false){$Wfx=-1;$Wev=Wbf(unserialize($Wev));if($Wcb)$Wgf[]=array('bp'=>$Wep,'bq'=>$Wgs,'br'=>0,'bs'=>Wdf());if($Wge)Wc_($Wev);if($Wgg){$Wej+=microtime(true)-$Wgd;$Wgd=false;}return$Wev;}}}elseif($Wgp=="DELETE"||$Wgp=="INSERT"||$Wgp=="UPDATE"||$Wgp=="REPLAC"){$Wgt=true;if(strpos($Wep,"SET viewed = (viewed + 1)"))$Wgt=false;if($Wgt)$this->Wbd($Wep);}$Wba=microtime(true);$Wev=$this->driver->query($Wep);$Wee++;$Wef--;$Wgq=microtime(true)-$Wba;$Wek+=$Wgq;if($Wcb)$Wgf[]=array('bp'=>$Wep,'bq'=>false,'br'=>$Wgq,'bs'=>Wdf());if($Wgp=="SELECT"){if(!$light_cache_only_slow_sql||$Wgq>$Wgn||Wbg($Wep))if(!strpos(strtoupper($Wep)," RAND()")){$Wgu=$Wev->rows;if(strpos($Wep,"SQL_CALC_FOUND_ROWS")){$Wba=microtime(true);$Wgv=$this->driver->query("SELECT FOUND_ROWS()")->row;$Wgq=microtime(true)-$Wba;$Wek+=$Wgq;$Wgv=reset($Wgv);$Wgu['n']=$Wgv;global$Wfx;$Wfx=$Wgv;}$Wgu=serialize($Wgu);if(strlen($Wgu)<1024*1024)Waf($Wep,$Wgu);}}if($Wgg){$Wej+=microtime(true)-$Wgd;$Wgd=false;}if($Wge)Wc_($Wev);return$Wev;}public function Wbh($Wgw){if(is_array($Wgw))return array_map(__METHOD__,$Wgw);if(!empty($Wgw)&&is_string($Wgw)){return str_replace(array('\\',"\0","\n","\r","'",'"',"\x1a"),array('\\\\','\\0','\\n','\\r',"\\'",'\\"','\\Z'),$Wgw);}return$Wgw;}public function escape($Wdv){if(!$this->driver)return$this->Wbh($Wdv);return$this->driver->escape($Wdv);}public function countAffected(){return$this->driver->countAffected();}public function getLastId(){return$this->driver->getLastId();}public function __destruct(){unset($this->driver);}}function Wdc($Wer){if($Wer<1)$Wer=round($Wer,3);elseif($Wer<2)$Wer=round($Wer,2);elseif($Wer<6)$Wer=round($Wer,1);else$Wer=round($Wer);return($Wer);}function Wdd(){echo"<h2>Page Generation Metrics</h2>";global$Wed,$Wee,$Wef,$Wej,$Wek;$Weg=microtime(true)-$Wed;echo"Total: ".Wdc($Weg)." sec. <br/>";$Wel=$Weg-$Wej;echo"PHP: ".Wdc($Wel)." sec. (".round($Wel/$Weg*100)."%)<br/>";$Wem=$Wej-$Wek;echo"Beta: ".Wdc($Wem)." sec. (".round($Wem/$Weg*100)."%)<br/>";echo"SQL: ".Wdc($Wek)." sec. (".round($Wek/$Weg*100)."%)<br/>";echo"<br/>";echo"<h2>SQL Queries</h2>";echo"Cached queries: ".$Wef."<br/>";echo"Real queries: ".$Wee."<br/>";echo"<br/>";global$Wgf;$Wgx="";foreach($Wgf as$Wgy){if($Wgy['bs']!=$Wgx){echo"<h4>".$Wgy['bs']."</h4>";$Wgx=$Wgy['bs'];}echo"<div class='li_query' style='margin-top:10px;";if($Wgy['bq'])echo"color: grey";echo"'>";echo$Wgy['bp'];if($Wgy['br'])echo" (".Wdc($Wgy['br'])." sec)";echo"</div>";}}function Wcs(){if(!defined("VERSION")||VERSION<"2.0"){$W_=DIR_DATABASE.DB_DRIVER.".php";if(file_exists($W_)){require_once($W_);$Wgz="DB".DB_DRIVER;if(!class_exists($Wgz))$Wgz=DB_DRIVER;return new$Wgz(DB_HOSTNAME,DB_USERNAME,DB_PASSWORD,DB_DATABASE);}else{exit("Lightning: Could not load database driver type ".DB_DRIVER.'!');}}else{$W_=DIR_SYSTEM."library/db/".DB_DRIVER.".php";require_once($W_);$Wgz="DB\\".DB_DRIVER;if(class_exists($Wgz)){return new$Wgz(DB_HOSTNAME,DB_USERNAME,DB_PASSWORD,DB_DATABASE);}else{exit("Lightning: Could not load database driver ".DB_DRIVER.'!');}}}function Wbg(&$Wep){global$Wfw;if(strpos($Wep,"ELECT COUNT")and strpos($Wep,"product_id) AS total"))return true;if(strpos($Wep,"'information_id="))return true;$Wf_=Wcy("\* FROM "," ",$Wep);if(!$Wf_){$Wf_=Wcy(" xseo FROM "," ",$Wep);if(!$Wf_)return false;}if(substr($Wf_,0,1)=="`")$Wf_=substr($Wf_,1,-1);$Wf_=substr($Wf_,strlen(DB_PREFIX));if(!in_array($Wf_,$Wfw))return false;if($Wf_=="setting")Waz(true);return true;}global$Wgl;$Wgl=file_exists(DIR_LOGS.'ba');function Wbf($Wg_){$Wdo=new stdClass();if(!$Wg_){$Wdo->rows=array();$Wdo->row=array();$Wdo->num_rows=0;return$Wdo;}if(isset($Wg_['n'])){global$Wfx;$Wfx=$Wg_['n'];unset($Wg_['n']);}$Wdo->rows=$Wg_;$Wdo->num_rows=count($Wg_);if($Wdo->num_rows)$Wdo->row=reset($Wg_);else$Wdo->row=array();return$Wdo;}function Wbi(){foreach(glob(DIR_CACHE."lightning/".'c'."*")as$Wha)if(is_file($Wha))unlink($Wha);}function Wbj($Wbn){if(substr_count($Wbn,'/')==2)$Wbn=substr($Wbn,0,strrpos($Wbn,'/'));if(!in_array($Wbn,array("setting/setting","localisation/language","localisation/currency","catalog/category","catalog/information")))return;Wbi();}function Waz($Whb=false){if(!$Whb and file_exists(DIR_CACHE."lightning"))return;static$Whc;if($Whc)return;$Whc=true;global$db;if($db){Wbk('product_to_category','category_id');Wbk('url_alias','query');Wbk('url_alias','keyword');Wbk('product_option_value','product_id');Wbk('product_special','product_id');Wbk('product','model');Wbk('product_image','product_id');Wbk('product_option','product_id');}$Wa_=substr(DIR_SYSTEM,0,-7)."index.php";$Whd="lightning/gamma.php";$Wdx=file_get_contents($Wa_);if(strpos($Wdx,$Whd))return;$Wt=strpos($Wdx,"index.php");$Wt=strpos($Wdx,"}",$Wt+1);if(!$Wt)return;$Wt++;$Wdx=substr($Wdx,0,$Wt)."\n\nif (file_exists(DIR_SYSTEM.'lightning/gamma.php')) require(DIR_SYSTEM.'lightning/gamma.php'); //Lightning".substr($Wdx,$Wt);file_put_contents($Wa_,$Wdx);$Wdx=file_get_contents($Wa_);if(!strpos($Wdx,$Whd)){echo"<h3>Failed to activate OpenCart Lightning - <font color='blue'>$Wa_</font> not writable!</h3>";exit;}}function Wcm(&$Wep){$Wep=preg_replace('/\s+/',' ',$Wep);}function Wbk($Wf_,$Whe,$Whf=false){global$db;if(!$db)return;$Wak=$Whe;if($Whf)$Wak.="_".$Whf;if($db->query("SHOW KEYS FROM `".DB_PREFIX."$Wf_` WHERE Key_name='$Wak'")->row)return;if(!$Whf)$db->query("ALTER TABLE `".DB_PREFIX."$Wf_` ADD INDEX `$Whe` (`$Whe`)");else$db->query("ALTER TABLE `".DB_PREFIX."$Wf_` ADD INDEX `$Wak` (`$Whe`,`$Whf`)");}define('Wbb',"/meters");function Wbl(){global$Whg,$Whh,$Wy,$Wdb,$Wfy;if(!$Whg)$Whg=0;$Whh[$Whg][0]=$Wy;$Whh[$Whg][1]=$Wdb;$Whh[$Whg][2]=$Wfy;$Whg++;}function Wbm(){global$Whg,$Whh,$Wy,$Wdb,$Wfy;$Whg--;$Wy=$Whh[$Whg][0];$Wdb=$Whh[$Whg][1];$Wfy=$Whh[$Whg][2];}function Wr($Whi=false,$Whj=false){global$Wy;$W_=$Wy.Wbb;if(file_exists($W_)){$Way=explode(',',Wbn($W_));if(!$Whi and!$Whj)return$Way;$Whk=$Way[0];$War=$Way[1];}else{$Whk=0;$War=0;}$Whk+=$Whi;if($Whk<0)$Whk=0;$War+=$Whj;if($War<0)$War=0;file_put_contents($W_,$Whk.','.$War,LOCK_EX);}function Wbn($W_){$Whl=fopen($W_,'rt');flock($Whl,LOCK_SH);$Wev=file_get_contents($W_);fclose($Whl);return$Wev;}function Waf($Wdu,$Way,$Whm=false){global$Wy,$Wfy;if(Wba($Wy))if($Wfy)file_put_contents($Wy.Wbb,"0,0");global$Wdj,$Wc;if($Wdj<$Wc)return;$Wz=md5($Wdu);$Wgc=$Wy."/".substr($Wz,0,2);if($Whm)Wcv($Wgc);$W_=$Wgc."/c".substr($Wz,2);if($Wfy){$Whk=0;if(file_exists($W_))$War=strlen($Way)-filesize($W_);else{$War=strlen($Way);$Whk=1;}Wr($Whk,$War);}Wba($Wgc);file_put_contents($W_,$Way);}function Wbo($W_){static$Whn;if(!$Whn)$Whn=phpversion();if($Whn<"5.3")clearstatcache();else clearstatcache(true,$W_);}function Ws($Wdu){global$Wy;$Wz=md5($Wdu);$Wgc=$Wy."/".substr($Wz,0,2);$W_=$Wgc."/c".substr($Wz,2);Wbo($W_);if(!file_exists($W_))return false;return(filemtime($W_));}function Wai($Wdu,$Wba,$Whb=false){global$Wy;$Wz=md5($Wdu);$Wgc=$Wy."/".substr($Wz,0,2);Wba($Wgc);$W_=$Wgc."/c".substr($Wz,2);if(!file_exists($W_)){if(!$Whb)return;file_put_contents($W_,'');global$Wfy;if($Wfy)Wr(1,0);}touch($W_,$Wba);}function Wah($Wdu,$Who=false){global$Wy,$Wdb,$Wgs;$Wgs=false;$Wz=md5($Wdu);$Wgc=$Wy."/".substr($Wz,0,2);$W_=$Wgc."/c".substr($Wz,2);if($Wdb and!$Who)Wcv($Wgc);if(!file_exists($W_))return false;$Wgs=filemtime($W_);$Way=file_get_contents($W_);return$Way;}function Wcv($Wgc){global$Wdb,$Wfy;if(!$Wdb)return;if(!file_exists($Wgc))return;$Wba=microtime(true);if(filemtime($Wgc)<$Wba-10*60){$Wba-=$Wdb;$Whk=0;$War=0;if(substr($Wgc,-1)=="/")$Wgc=substr($Wgc,0,-1);$Whp=glob($Wgc."/c*");if($Whp)foreach($Whp as$Wha){Wbo($Wha);if(filemtime($Wha)<$Wba){$Whk++;if($Wfy)$War+=filesize($Wha);@unlink($Wha);}}touch($Wgc);if($Wfy)Wr(-$Whk,-$War);}}function Wu($Wdu=false){global$Wy,$Wfy;if($Wdu){$Wz=md5($Wdu);$Wgc=$Wy."/".substr($Wz,0,2);$W_=$Wgc."/c".substr($Wz,2);if(file_exists($W_)){Wbo($W_);Wr(-1,filesize($W_));unlink($W_);}return;}foreach(glob($Wy."/*")as$Wgc){if(is_dir($Wgc)){foreach(glob($Wgc."/*")as$Wha)@unlink($Wha);rmdir($Wgc);}else @unlink($Wgc);}if($Wfy and file_exists($Wy.Wbb))@unlink($Wy.Wbb);}function Wbc($Wcu,$Wfu,$Wcn){preg_match_all("/$Wcu([^$Wfu]*)/i",$Wcn,$Wfd);return($Wfd[1]);}function Wcy($Wcu,$Wfu,&$Wcn){preg_match("/$Wcu([^$Wfu]*)/i",$Wcn,$Wfd);if(isset($Wfd[1]))return($Wfd[1]);else return"";}function Wbp($Wcu,$Wav="",$Wcn){$Wau=array();$Wcp=0;while(($Wcp=strpos($Wcn,$Wcu,$Wcp))!==false){$Wcp+=strlen($Wcu);$Wcs=strpos($Wcn,$Wav,$Wcp);if($Wcs!==false){$Wau[]=trim(substr($Wcn,$Wcp,$Wcs-$Wcp));$Wcp=$Wcs+strlen($Wav);}}return$Wau;}function Wbq($Whq=false,$Wcm='',$Wcn=false){if(($Wt=strpos($Whq,'*'))!==false){$Wco=substr($Whq,0,$Wt);$Wcr=substr($Whq,$Wt+1);$Wau=Wbr("","",$Wco,$Wcr,$Wcn);$Wau=str_ireplace($Wco.$Wcr,$Wcm,$Wau);}else $Wau=str_ireplace($Whq,$Wcm,$Wcn);return$Wau;}function Wbr($Wct,$Wcm,$Wcu,$Wav,$Wcn){$Wcp=0;while(($Wcp=stripos($Wcn,$Wcu,$Wcp))!==false){$Wcp+=strlen($Wcu);if($Wav)$Wcs=stripos($Wcn,$Wav,$Wcp);else$Wcs=strlen($Wcn);if($Wcs){$Wcv=substr($Wcn,0,$Wcp);$Wcw=substr($Wcn,$Wcs);$Wcx=substr($Wcn,$Wcp,$Wcs-$Wcp);$Wcy=strlen($Wcx);if($Wct!=='')$Wcx=str_ireplace($Wct,$Wcm,$Wcx);else$Wcx=$Wcm;$Wcn=$Wcv.$Wcx.$Wcw;$Wcs=$Wcs+strlen($Wcx)-$Wcy;$Wcp=$Wcs+strlen($Wav);if($Wcp>strlen($Wcn))break;}}return$Wcn;}function Wy($Wcu,$Wav="",$Wcn){$Wau='';if($Wcu)$Wcp=stripos($Wcn,$Wcu);else$Wcp=0;if($Wcp!==false){$Wcp+=strlen($Wcu);if($Wav)$Wcs=stripos($Wcn,$Wav,$Wcp);else$Wcs=strlen($Wcn);if($Wcs!==false)$Wau=trim(substr($Wcn,$Wcp,$Wcs-$Wcp));}return$Wau;}function Wba($Whr){if(file_exists($Whr))return false;Wbs();mkdir($Whr,0777,true);chmod($Whr,0777);Wbt();return true;}function Wbs(){global$config,$Wam,$Whs,$Wht;if($Wam)return;if(!$config)return;$Wam=true;$Whs=$config->get("config_error_display");$Wht=$config->get("config_error_log");$config->set("config_error_display",0);$config->set("config_error_log",0);}function Wbt(){global$config,$Wam,$Whs,$Wht;if(!$Wam)return;if(!$config)return;$Wam=false;$config->set("config_error_display",$Whs);$config->set("config_error_log",$Wht);}function Wbu($Wep){if(strpos($Wep,"ORDER BY p.date_added")){$Wep=Wbq("ORDER BY p.date_added*DESC ","ORDER BY p.product_id DESC ",$Wep." ");$Wep=Wbq("ORDER BY p.date_added*ASC ","ORDER BY p.product_id ASC ",$Wep);return trim($Wep);}if(!strpos($Wep,"FROM ".DB_PREFIX."product_to_category p2c"))return false;$Wep=Wbq("ORDER BY p.sort_order*ASC ","ORDER BY p2c.product_id DESC ",$Wep." ");return trim($Wep);}function Wbv($Wep){return array(array("total"=>0));}function Wbw($Wep){static$Whu;if(isset($Whu[$Wep]))return$Whu[$Wep];$Wev=Wbx($Wep);$Whu[$Wep]=$Wev;return$Wev;}function Wby($Wep){$Wdo=Wcy("`query` = '","'",$Wep);global$Whv;if(!isset($Whv[$Wdo])){$Wev=Wbx($Wep);if($Wev){$Whw=reset($Wev);if(count($Wev)>1||count($Whw)>3)$Whv[$Wdo]=$Wev;else{$Wev=reset($Wev);$Whv[$Wdo]=$Wev["keyword"];}}else$Whv[$Wdo]=false;};$Whx=$Whv[$Wdo];if($Whx===false)return array();if(is_array($Whx))return$Whx;return array(array("query"=>$Wdo,"keyword"=>$Whv[$Wdo]));}function Wbz($Wep){global$light_group_queries;if(!$light_group_queries)return false;static$Why,$Wfq;if(!strpos($Wep,"ELECT DISTINCT *, pd.name")){$Wev=Wbx($Wep);$Why=array();if(count($Wev)<1024)foreach($Wev as$Wfr)if(!empty($Wfr["product_id"]))$Why[]=$Wfr["product_id"];return$Wev;}$Whz=Wcy("p.product_id = '","'",$Wep);if(!$Whz)return false;if(!empty($Wfq[$Whz]))return array($Wfq[$Whz]);if(empty($Why)or!in_array($Whz,$Why)){if($Wfq and count($Wfq)>1024)return false;$Wev=Wbx($Wep);if(count($Wev)<1024)foreach($Wev as$Wfr){$Wfq[$Wfr["product_id"]]=$Wfr;if(isset($Wfr["xseo"]))$Whv["product_id=".$Wfr["product_id"]]=$Wfr["xseo"];}return$Wev;};if($Wfq and count($Wfq)>1024)return false;$Wep=str_replace("p.product_id = '$Whz'","p.product_id IN (".implode(",",$Why).")",$Wep);global$config;$Wdd=$config->get("config_seo_url");if($Wdd){global$Wh_;if(!$Wh_)$Wh_=Wde();$Wep=str_replace("AS discount,","AS discount, "."(SELECT `keyword` FROM ".DB_PREFIX."url_alias WHERE `query` = CONCAT('product_id=', p.product_id) $Wh_) as xseo,",$Wep);}$Wev=Wbx($Wep);$Why=false;global$Whv;foreach($Wev as$Wfr){$Wfq[$Wfr["product_id"]]=$Wfr;if($Wdd){if(empty($Wfr["xseo"]))$Wfr["xseo"]=false;$Whv["product_id=".$Wfr["product_id"]]=$Wfr["xseo"];}}if(empty($Wfq[$Whz]))return false;return array($Wfq[$Whz]);}function Wb_($Wep){$Wep=str_replace("p2s.store_id = 0","p2s.store_id = '0'",$Wep);$Wep=Wbq(" AND p2s.store_id = '*'","",$Wep);if(strpos($Wep,"store_id"))return false;return Wbq(" LEFT JOIN ".DB_PREFIX."product_to_store p2s ON (*)","",$Wep);}function Wca($Wep){$Wep=str_replace("LCASE(name)","LCASE(pd.name)",$Wep);if(!strpos($Wep,"pd.name")or!strpos($Wep,"product p "))return false;if(strpos($Wep,"as innertable"))return false;$Wep=str_replace("LCASE(pd.name) ASC, LCASE(pd.name)","LCASE(pd.name)",$Wep);$Wep=str_replace("LCASE(pd.name) DESC, LCASE(pd.name)","LCASE(pd.name)",$Wep);$Wep=Wbq("ORDER BY pd.name","ORDER BY p.model",$Wep);$Wep=Wbq("LCASE(pd.name) ASC","p.model ASC",$Wep);$Wep=Wbq("LCASE(pd.name) DESC","p.model DESC",$Wep);if(!strpos($Wep,"pd.")and!strpos($Wep,"name")){$Wep=Wbq(" LEFT JOIN ".DB_PREFIX."product_description pd ON (*)","",$Wep);}return$Wep;}function Wcb($Wep){if(strpos($Wep,"*")or strpos($Wep,"name"))return false;$Wep=Wbq(" pd.language_id = '*' AND","",$Wep);$Wep=Wbq(" WHERE pd.language_id = '*'","",$Wep);$Wep=Wbq(" LEFT JOIN ".DB_PREFIX."product_description pd ON (*)","",$Wep);if(strpos($Wep,"pd."))return false;$Wep=Wbq("COUNT(DISTINCT p.product_id)","COUNT(p.product_id)",$Wep);return$Wep;}function Wcc($Wep){if(strpos($Wep,"MIN(")or strpos($Wep,"MAX(")or strpos($Wep,"SUM("))return false;$Wep=Wbq(" GROUP BY p.product_id","",$Wep);return$Wep;}function Wcd($Wia){static$Wbx;if(!$Wbx){$Wib=Wbx("SELECT category_id, parent_id FROM ".DB_PREFIX."category");$Wic=array();$Wbx=array();foreach($Wib as$Wid){$Wic[$Wid["category_id"]]=$Wid["parent_id"];$Wbx[$Wid["parent_id"]][]=$Wid["category_id"];}$Wie=array();foreach($Wic as$Wif=>$Wig)if(empty($Wbx[$Wif]))$Wie[$Wif]=true;$Wih=true;while($Wih){$Wii=array();$Wih=false;foreach($Wic as$Wif=>$Wig)if(!empty($Wie[$Wif])and empty($Wie[$Wig])){if(!empty($Wbx[$Wif]))$Wbx[$Wig]=array_unique(array_merge($Wbx[$Wig],$Wbx[$Wif]));if(!in_array($Wig,$Wii))$Wii[]=$Wig;$Wih=true;}foreach($Wii as$Wid)$Wie[$Wid]=true;}}if(empty($Wbx[$Wia]))return$Wia;return$Wia.','.implode(',',$Wbx[$Wia]);}function Wda($Way,$Wij){static$Wik;if(!$Wik)$Wik=time()-60*60;$Way[]=$Wij;global$Wge,$Wgs;$Wge=implode("/",$Way);$Wev=Wah($Wge,true);if($Wgs<$Wik+rand(0,10*60))return-1;if(!is_numeric($Wev))return-1;$Wge=false;return$Wev;}function Wc_($Wev){global$Wge;if(!isset($Wev->row["total"])){$Wge=false;return;}Waf($Wge,$Wev->row["total"]);$Wge=false;}function Wce($Wep){return false;}function Wcg($Wep){$Wil=Wcy("AND cp.path_id = '","'",$Wep);if(!$Wil)return false;global$config,$Wim;if($Wim)if(!$config->get("config_product_count")and$config->has("config_product_count")){if(strpos($Wep,"COUNT(DISTINCT p.product_id) AS total"))return array(array("total"=>0));}$Wep=str_replace(" FROM ".DB_PREFIX."category_path cp LEFT JOIN ".DB_PREFIX."product_to_category p2c ON (cp.category_id = p2c.category_id)"," FROM ".DB_PREFIX."product_to_category p2c",$Wep);$Wib=Wcd($Wil);if(strpos($Wib,','))$Wib="IN ($Wib)";else$Wib="= $Wib";$Wep=str_replace(" AND cp.path_id = '".$Wil."'"," AND p2c.category_id ".$Wib,$Wep);$Wep=str_replace(" AND cp.path_id = '".$Wil."'"," AND p2c.category_id ".$Wib,$Wep);return$Wep;}function Wde(){global$config;$Win=Wbx("SHOW COLUMNS FROM ".DB_PREFIX."url_alias LIKE 'lang'");if($Win)return"AND lang='".$config->get("config_language_id")."' LIMIT 1";$Win=Wbx("SHOW COLUMNS FROM ".DB_PREFIX."url_alias LIKE 'language_id'");if($Win)return"AND language_id='".$config->get("config_language_id")."' LIMIT 1";return"LIMIT 1";}function Wch($Wep){global$light_group_queries;if(!$light_group_queries)return false;if(!strpos($Wep,"FROM ".DB_PREFIX."category c LEFT JOIN"))return false;static$Wib;global$config;if(!$Wib){$Wdo="SELECT * FROM ".DB_PREFIX."category c LEFT JOIN ".DB_PREFIX."category_description cd ON (c.category_id=cd.category_id) LEFT JOIN ".DB_PREFIX."category_to_store c2s ON (c.category_id = c2s.category_id) WHERE cd.language_id = '".(int)$config->get("config_language_id")."' AND c2s.store_id = '".(int)$config->get("config_store_id")."'  AND c.status = '1' ORDER BY c.sort_order, LCASE(cd.name)";global$config;$Wdd=$config->get("config_seo_url");if($Wdd){global$Wh_;if(!$Wh_)$Wh_=Wde();$Wdo=str_replace("* FROM","*, (SELECT `keyword` FROM ".DB_PREFIX."url_alias WHERE `query` = CONCAT('category_id=', c.category_id) $Wh_) as xseo FROM",$Wdo);}$Wio=Wbx($Wdo);$Wib=array();foreach($Wio as$Wfr){$Wfr["children"]=0;$Wib[$Wfr["category_id"]]=$Wfr;}global$Whv;foreach($Wib as$Wfr){if($Wdd){if(empty($Wfr["xseo"]))$Wfr["xseo"]=false;$Whv["category_id=".$Wfr["category_id"]]=$Wfr["xseo"];}if(isset($Wib[$Wfr["parent_id"]]))$Wib[$Wfr["parent_id"]]["children"]++;}}$Wip=Wcy("c.parent_id = '","'",$Wep);if($Wip!==''){$Wev=array();foreach($Wib as$Wfr)if($Wfr["parent_id"]==$Wip)$Wev[]=$Wfr;return$Wev;}if(!$Wib)return false;$Wia=Wcy("c.category_id = '","'",$Wep);if(!$Wia)return false;$Wev=array();foreach($Wib as$Wfr){if($Wfr["category_id"]==$Wia){$Wev[]=$Wfr;return$Wev;}}return false;}function Wcf($Whq=false){$Wgj=debug_backtrace();$Wax="";foreach($Wgj as$Wbk=>$Wey){if($Wbk<3)continue;$Wgk=$Wey["function"];if($Wgk=="call_user_func_array")break;if(!empty($Wey["class"]))$Wgk=$Wey["class"].":".$Wgk;if($Wax)$Wax=$Wgk." -> ".$Wax;else$Wax=$Wgk;}if(!$Whq)return$Wax;$Whq=explode(',',$Whq);foreach($Whq as$Wiq)if(strpos($Wax,$Wiq)!==false)return true;return false;}function Wcz($Wir){$Wir=explode(", ",$Wir);$Wgj=debug_backtrace(false);foreach($Wgj as$Wbk=>$Wey){if(empty($Wey["class"]))continue;if(in_array($Wey["class"],$Wir))return true;}return false;}function Wbx($Wep){global$db,$light_optimize;$Wch=$light_optimize;$light_optimize=false;$Wev=$db->query($Wep)->rows;$light_optimize=$Wch;return$Wev;}function Wbe(&$Wep){global$Wis,$Wit;if(!$Wis){$Wiu=DIR_CACHE."lightning/".'c'.'bd';if(!file_exists($Wiu)){$light_optimize=false;return;}$Wis=unserialize(file_get_contents($Wiu));foreach($Wis as&$Wiv)$Wiv=explode(" | ",$Wiv);}if(substr($Wep,0,6)!=="SELECT")return;$Wit=array();foreach($Wis as$Wak=>$Whq)if(true){$Wck=false;foreach($Whq as$Wcq)if(strpos($Wep,$Wcq)!==false){$Wck=true;break;}if(!$Wck)continue;$Wiw=$Wak($Wep);if(is_array($Wiw)){$Wep=$Wiw;return;}if(!$Wiw)continue;$Wep=$Wiw;}return;}function Wdf(){$Wgj=debug_backtrace();$Wax="";foreach($Wgj as$Wbk=>$Wey){if($Wbk<3)continue;$Wgk=$Wey["function"];if($Wgk=="call_user_func_array")break;if(!empty($Wey["class"]))$Wgk=$Wey["class"].":".$Wgk;if($Wax)$Wax=$Wgk." -> ".$Wax;else$Wax=$Wgk;}return$Wax;}